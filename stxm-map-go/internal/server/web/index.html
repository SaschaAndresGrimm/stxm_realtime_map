<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>STXM Real-time Map</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <div class="brand">
        <img class="brand-logo" src="assets/dectris-logo.svg" alt="DECTRIS logo" />
        <h1>STXM Real-Time Map</h1>
      </div>
      <div class="header-status">
        <div id="status">Connecting…</div>
      </div>
    </header>
    <div id="stale-banner" class="stale-banner hidden">No data (stream stalled)</div>
    <div id="panel-handle" class="panel-handle" title="Drag to resize"></div>
    <aside id="control-panel" class="panel">
      <div class="panel-top">
        <div class="panel-header">
          <h2>Controls</h2>
        </div>
      <div class="panel-tabs" role="tablist" aria-label="Control tabs">
        <button class="panel-tab-btn is-active" data-panel-tab="ui" role="tab" aria-selected="true" aria-label="UI Settings">
          <span class="tab-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M4 5h16M4 12h10M4 19h16" stroke-width="1.6" stroke-linecap="round"/>
              <circle cx="17" cy="12" r="2.3" stroke-width="1.6"/>
            </svg>
          </span>
          <span class="tab-label tab-label--long">UI Settings</span>
          <span class="tab-label tab-label--short">UI</span>
        </button>
        <button class="panel-tab-btn" data-panel-tab="detector" role="tab" aria-selected="false" aria-label="Detector">
          <span class="tab-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <rect x="4" y="6" width="16" height="12" rx="2" stroke-width="1.6"/>
              <circle cx="9" cy="12" r="2.2" stroke-width="1.6"/>
              <path d="M14 12h4" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </span>
          <span class="tab-label tab-label--long">Detector</span>
          <span class="tab-label tab-label--short">Det</span>
        </button>
      </div>
      </div>
      <div class="panel-tab" data-panel-page="ui">
        <div class="panel-section">
          <label class="toggle">
            <span>Color scheme</span>
            <select id="color-scheme">
              <option value="blue-yellow-red" selected>Blue-Yellow-Red</option>
              <option value="gray">Grayscale</option>
              <option value="heat">Heat</option>
              <option value="viridis">Viridis</option>
              <option value="albula-hdr">Albula HDR</option>
            </select>
          </label>
          <label class="toggle">
            <input type="checkbox" id="autoscale" checked />
            <span>Auto scale</span>
          </label>
          <div class="histogram">
            <div class="histogram-title">Histogram</div>
            <div class="histogram-axis">
              <span class="histogram-y-label">Count</span>
              <div class="histogram-canvas-wrap">
                <canvas id="histogram-canvas" width="240" height="80"></canvas>
                <span class="histogram-x-label">Value</span>
              </div>
            </div>
            <label class="toggle histogram-toggle">
              <input type="checkbox" id="histogram-log" checked />
              <span>Log scale</span>
            </label>
          </div>
          <div class="contrast-controls">
            <div class="contrast-row">
              <span>Min</span>
              <input id="contrast-min" type="range" min="0" max="255" step="1" value="0" />
              <span id="contrast-min-value">0</span>
            </div>
            <div class="contrast-row">
              <span>Max</span>
              <input id="contrast-max" type="range" min="0" max="255" step="1" value="255" />
              <span id="contrast-max-value">255</span>
            </div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="sync-views" checked />
            <span>Sync views</span>
          </label>
        </div>
        <div class="panel-section">
          <div class="panel-hint">Scan grid (points to plot).</div>
          <div class="detector-form">
            <label>
              <span>Grid X</span>
              <input id="grid-x" type="number" step="1" min="1" placeholder="52" />
            </label>
            <label>
              <span>Grid Y</span>
              <input id="grid-y" type="number" step="1" min="1" placeholder="52" />
            </label>
          </div>
          <div class="detector-actions">
            <button id="grid-apply" class="export-btn export-wide">Apply grid</button>
          </div>
          <div id="grid-status" class="panel-hint">Grid unchanged.</div>
        </div>
        <div class="panel-section">
          <div class="zoom-controls">
            <button id="zoom-out" class="export-btn">-</button>
            <span id="zoom-level">1.0x</span>
            <button id="zoom-in" class="export-btn">+</button>
          </div>
          <input id="zoom-slider" type="range" min="0.5" max="8" step="0.1" value="1" />
          <button id="zoom-reset" class="export-btn">Reset</button>
        </div>
        <div class="panel-section">
          <button id="export-snapshot" class="export-btn export-wide">Export Snapshot</button>
        </div>
      </div>
      <div class="panel-tab is-hidden" data-panel-page="detector">
        <div class="panel-section">
          <div class="panel-hint">Detector connection.</div>
          <div class="detector-form">
            <label>
              <span>Detector IP</span>
              <input id="detector-ip" type="text" placeholder="192.168.20.88" />
            </label>
            <label>
              <span>ZMQ port</span>
              <input id="detector-zmq-port" type="number" step="1" min="1" placeholder="31001" />
            </label>
            <label>
              <span>API port</span>
              <input id="detector-api-port" type="number" step="1" min="1" placeholder="80" />
            </label>
          </div>
          <div class="detector-actions">
            <button id="endpoint-apply" class="export-btn export-wide">Apply connection</button>
          </div>
          <div id="endpoint-status" class="panel-hint">Connection unchanged.</div>
        </div>
        <div class="panel-section">
          <div class="panel-hint">
            Detector commands are sent via the SIMPLON API.
          </div>
          <div class="detector-controls">
            <button class="export-btn detector-btn" data-detector-cmd="initialize">Initialize</button>
            <button class="export-btn detector-btn" data-detector-cmd="arm">Arm</button>
            <button class="export-btn detector-btn" data-detector-cmd="trigger">Trigger</button>
            <button class="export-btn detector-btn" data-detector-cmd="disarm">Disarm</button>
          </div>
          <div id="detector-command-status" class="panel-hint">No command sent yet.</div>
        </div>
        <div class="panel-section">
          <div class="panel-hint">Acquisition settings (SIMPLON config).</div>
          <div class="detector-form">
            <label>
              <span>count_time (s)</span>
              <input id="detector-count-time" type="number" step="0.000001" min="0" placeholder="0.0001" />
            </label>
            <label>
              <span>frame_time (s)</span>
              <input id="detector-frame-time" type="number" step="0.000001" min="0" placeholder="0.001" />
            </label>
            <label>
              <span>trigger_mode</span>
              <input id="detector-trigger-mode" type="text" placeholder="exts" />
            </label>
            <label>
              <span>ntrigger</span>
              <input id="detector-ntrigger" type="number" step="1" min="0" placeholder="1" />
            </label>
            <label>
              <span>nimages</span>
              <input id="detector-nimages" type="number" step="1" min="0" placeholder="8464" />
            </label>
          </div>
          <div class="detector-actions">
            <button id="detector-apply" class="export-btn export-wide">Apply settings</button>
          </div>
          <div id="detector-config-status" class="panel-hint">No settings applied yet.</div>
        </div>
        <div class="panel-section param-toolbar">
          <div class="panel-hint">Full SIMPLON parameter set.</div>
          <input id="param-search" class="param-search" type="search" placeholder="Search parameters (e.g., count_time, threshold/n/energy)" />
          <div class="param-filter-row">
            <label class="toggle">
              <input type="checkbox" id="param-filter-config" checked />
              <span>Config</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="param-filter-status" checked />
              <span>Status</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="param-filter-command" checked />
              <span>Command</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="param-filter-images" checked />
              <span>Images</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="param-favorites-only" />
              <span>Favorites only</span>
            </label>
          </div>
          <div class="param-filter-actions">
            <button id="param-expand" class="export-btn">Expand all</button>
            <button id="param-collapse" class="export-btn">Collapse all</button>
            <button id="param-favorites-edit" class="export-btn">Edit favorites</button>
          </div>
        </div>
        <div id="param-favorites-editor" class="param-editor is-hidden">
          <div class="panel-hint">One entry per line: module/section/parameter (e.g. detector/config/threshold/n/energy).</div>
          <textarea id="param-favorites-text" rows="6" placeholder="detector/config/count_time"></textarea>
          <div class="param-editor-actions">
            <button id="param-favorites-save" class="export-btn">Save favorites</button>
            <button id="param-favorites-cancel" class="export-btn">Cancel</button>
          </div>
        </div>
        <div id="param-browser" class="param-browser">
          <div class="panel-hint">Loading parameters…</div>
        </div>
      </div>
    </aside>
    <main>
      <div id="plots"></div>
    </main>
    <footer class="footer-status">
      <div id="fps">UI 0 Hz</div>
      <div id="recv-rate">RX 0 Hz</div>
      <div class="status-row">
        <span class="status-label">Detector</span>
        <span id="status-detector" class="status-pill">
          <span class="status-dot"></span>
          <span class="status-text">unknown</span>
        </span>
      </div>
      <div class="status-row">
        <span class="status-label">Stream</span>
        <span id="status-stream" class="status-pill">
          <span class="status-dot"></span>
          <span class="status-text">idle</span>
        </span>
      </div>
      <div class="status-row optional">
        <span class="status-label">Filewriter</span>
        <span id="status-filewriter" class="status-pill">
          <span class="status-dot"></span>
          <span class="status-text">idle</span>
        </span>
      </div>
      <div class="status-row optional">
        <span class="status-label">Monitor</span>
        <span id="status-monitor" class="status-pill">
          <span class="status-dot"></span>
          <span class="status-text">ok</span>
        </span>
      </div>
    </footer>
    <script src="app.js"></script>
  </body>
</html>
